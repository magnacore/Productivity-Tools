#!/home/manuj/anaconda3/envs/xonsh/bin/xonsh
light_green = '\x1b[1;32m'
no_color = '\x1b[0m'

import os
import glob
import datetime
from tqdm import tqdm
from tabulate import tabulate
from playsound import playsound

# import mimetypes
# mimetypes.init()

# get_mime is not detecting mka files
# def get_mime(file):
# 	mimestart = mimetypes.guess_type(file)[0]
# 
# 	if mimestart != None:
# 		mimestart = mimestart.split('/')[0]
# 		return mimestart
# 	else:
# 		return None

def get_mime(file):
	mimestart = $(file --mime-type @(file))

	if mimestart != None:
		mimestart = mimestart.split(':')[1]
		mimestart = mimestart.split('/')[0]
		return mimestart.strip().lower()
	else:
		return None

def get_duration(file):
	duration = $(ffprobe -v quiet -of csv=p=0 -show_entries format=duration @(file))

	if duration == '':
		print(f"{file} is not returning a valid duration.")
		duration = '0'

	return float(duration)

allFiles = glob.glob("*.*")
allFiles.sort()

total_duration = 0.0


# for file in tqdm(allMediaFiles):
# 	duration = $(ffprobe -v quiet -of csv=p=0 -show_entries format=duration @(file))
# 	
# 	if duration:		
# 		total_duration += float(duration)

media_list = []
header = ["Name", "Duration"]

for file in tqdm(allFiles):
	mimestart = get_mime(file)
	if mimestart != None:
		if mimestart in ['audio', 'video']:
			duration = get_duration(file)
			total_duration += duration
			media_list.append([file, datetime.timedelta(seconds = round(duration,0))])
		else:
			print(f"Skipping {file}")

media_list.append([f"{light_green}Total media duration{no_color}",				f"{light_green}{datetime.timedelta(seconds = round(total_duration,0))}{no_color}"])
media_list.append([f"{light_green}Total media duration @1.5x speed{no_color}", 	f"{light_green}{datetime.timedelta(seconds = round(total_duration/1.5,0))}{no_color}"])
media_list.append([f"{light_green}Total media duration @1.65x speed{no_color}",	f"{light_green}{datetime.timedelta(seconds = round(total_duration/1.65,0))}{no_color}"])
media_list.append([f"{light_green}Total media duration @1.82x speed{no_color}",	f"{light_green}{datetime.timedelta(seconds = round(total_duration/1.82,0))}{no_color}"])
media_list.append([f"{light_green}Total media duration @2x speed{no_color}",	f"{light_green}{datetime.timedelta(seconds = round(total_duration/2,0))}{no_color}"])

print(tabulate(media_list, headers=header, tablefmt="fancy_grid"))

# print(f"{light_green}Total media duration:{no_color}")
# print(datetime.timedelta(seconds = round(total_duration,0)))

# print(f"{light_green}Total media duration @1.5x speed:{no_color}")
# print(datetime.timedelta(seconds = round(total_duration/1.5,0)))

# print(f"{light_green}Total media duration @1.65x speed:{no_color}")
# print(datetime.timedelta(seconds = round(total_duration/1.65,0)))

# print(f"{light_green}Total media duration @1.82x speed:{no_color}")
# print(datetime.timedelta(seconds = round(total_duration/1.82,0)))

# print(f"{light_green}Total media duration @2x speed:{no_color}")
# print(datetime.timedelta(seconds = round(total_duration/2,0)))

playsound(p"~/Bin/oxygen-sound-theme/Oxygen-K3B-Finish-Success.ogg")

print(u'\u2500' * os.get_terminal_size().columns)
