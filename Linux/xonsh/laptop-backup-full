#!/home/manuj/anaconda3/envs/xonsh/bin/xonsh
cyan = '\x1b[1;36m'
no_color = '\x1b[0m'

import os

print(f"{cyan}Open the container...{no_color}")
sudo cryptsetup luksOpen /dev/sda luks-laptop-backup-full

print(f"{cyan}Mount the container...{no_color}")
sudo mkdir /mnt/$USER/laptop_backup_full

# Change the owner
sudo chown $USER:$USER /mnt/$USER/laptop_backup_full

import time
# Give some time to /dev/vg-laptop-backup-full/raid1-1 to become available
print(f"{cyan}Waiting for 5 seconds before mounting...{no_color}")
time.sleep( 5 )

# mount the directory
if !(sudo mount p"/dev/vg-laptop-backup-full/raid1-1" p"/mnt/$USER/laptop_backup_full"):
    print(f"{cyan}Deleting previous snapshot...{no_color}")
    sudo btrfs subvolume delete /mnt/$USER/laptop_backup_full/@previous

    print(f"{cyan}Creating a new snapshot...{no_color}")
    sudo btrfs subvolume snapshot -r /mnt/$USER/laptop_backup_full/@current /mnt/$USER/laptop_backup_full/@previous

    print(f"{cyan}Synchronizing...{no_color}")
    rsync --delete --progress -vahi $HOME/ /mnt/$USER/laptop_backup_full/@current

    date > ~/Software/logs/laptop-backup-full.txt

    sudo btrfs filesystem show

    print(u'\u2500' * os.get_terminal_size().columns)

else:
    print(f"{cyan}Something went wrong. Could not mount.{no_color}")
